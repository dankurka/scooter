<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Controllerboard for balancing Scooter, Testsuite: stabilizer.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>stabilizer.c</h1><a href="stabilizer_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//////////////////////////////////////////////////////////////////</span>
<a name="l00002"></a>00002 <span class="comment"></span><span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">//   $Header: /cvs/Controller\040Board/AVR-Code/Testsuite/Doxygen-Doc/html/stabilizer_8c-source.html,v 1.3 2006/12/18 23:09:49 rainer Exp $</span>
<a name="l00004"></a>00004 <span class="comment">//   $Source: /cvs/Controller\040Board/AVR-Code/Testsuite/Doxygen-Doc/html/stabilizer_8c-source.html,v $</span>
<a name="l00005"></a>00005 <span class="comment">//   $Revision: 1.3 $</span>
<a name="l00006"></a>00006 <span class="comment">//</span><span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">//////////////////////////////////////////////////////////////////</span>
<a name="l00008"></a>00008 <span class="comment"></span><span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// Project: Controllerboard of balancing Scooter, Testsuite</span>
<a name="l00010"></a>00010 <span class="comment">//</span>
<a name="l00011"></a>00011 <span class="comment">// Author: Original C167 code by segway team, adaption to AVR by Rainer Ostendorf</span>
<a name="l00012"></a>00012 <span class="comment">//</span>
<a name="l00013"></a>00013 <span class="comment">// Description: controller algrorithm for platform stabilization</span>
<a name="l00014"></a>00014 <span class="comment">//</span>
<a name="l00015"></a>00015 <span class="comment">//      $Log: stabilizer.c,v $</span>
<a name="l00016"></a>00016 <span class="comment">//      Revision 1.4  2006/11/26 20:41:29  rainer</span>
<a name="l00017"></a>00017 <span class="comment">//      Changed polarity of PWM-Signal. Adjusted stabilization control parameters.</span>
<a name="l00018"></a>00018 <span class="comment">//</span>
<a name="l00019"></a>00019 <span class="comment">//      Revision 1.3  2006/11/24 22:04:28  rainer</span>
<a name="l00020"></a>00020 <span class="comment">//      Player around with real sensors and stabilization algorithm. Basic function seems to be ok, finetuning of factors to do.</span>
<a name="l00021"></a>00021 <span class="comment">//</span>
<a name="l00022"></a>00022 <span class="comment">//      Revision 1.2  2006/11/20 00:12:26  rainer</span>
<a name="l00023"></a>00023 <span class="comment">//      fixed typo</span>
<a name="l00024"></a>00024 <span class="comment">//</span>
<a name="l00025"></a>00025 <span class="comment">//      Revision 1.1  2006/11/20 00:04:46  rainer</span>
<a name="l00026"></a>00026 <span class="comment">//      Initial checkin. stabilization control algorithm, ported from C167. not yet tested.</span>
<a name="l00027"></a>00027 <span class="comment">//</span>
<a name="l00028"></a>00028 <span class="comment">//</span>
<a name="l00029"></a>00029 <span class="comment">//</span>
<a name="l00030"></a>00030 <span class="comment">//</span><span class="comment"></span>
<a name="l00031"></a>00031 <span class="comment">/////////////////////////////////////////////////////////////////</span>
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="globals_8h.html">globals.h</a>"</span> <span class="comment">/* there the ringbuffers for sensor-data are defined */</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="stabilizer_8h.html">stabilizer.h</a>"</span> <span class="comment">/* constants and scaling factor for controller-algorithm */</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="adc_8h.html">adc.h</a>"</span> <span class="comment">/* for reading the steering potentiometer */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="motor__pwm_8h.html">motor_pwm.h</a>"</span> <span class="comment">/* for PWM resolution */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#ifdef STABILIZE_DEBUG</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="uart_8h.html">uart.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="stabilizer_8h.html#cc3a7bb7e4532b65fe366e14f3778f86">00045</a> <span class="keywordtype">void</span> <a class="code" href="stabilizer_8c.html#cc3a7bb7e4532b65fe366e14f3778f86">stabilizer_loop</a>( <span class="keywordtype">void</span> )
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047                 <span class="comment">/* *****************************  V A R I A B L E S ******************/</span>
<a name="l00048"></a>00048                 <span class="comment">/* the two main physical values:</span>
<a name="l00049"></a>00049 <span class="comment">                 * </span>
<a name="l00050"></a>00050 <span class="comment">                 *      - the angle of the tilt, the platform has </span>
<a name="l00051"></a>00051 <span class="comment">                 *        against the direct of gravitiy</span>
<a name="l00052"></a>00052 <span class="comment">                 *  </span>
<a name="l00053"></a>00053 <span class="comment">                 *  - the angular speed of the platform around the </span>
<a name="l00054"></a>00054 <span class="comment">                 *    the axle of the wheels</span>
<a name="l00055"></a>00055 <span class="comment">                 * */</span>
<a name="l00056"></a>00056                 <span class="keywordtype">double</span> tilt_degrees;
<a name="l00057"></a>00057                 <span class="keywordtype">double</span> angular_speed;
<a name="l00058"></a>00058                 
<a name="l00059"></a>00059                 <span class="comment">/* average value of the first gyroskope, </span>
<a name="l00060"></a>00060 <span class="comment">                 * calculated out of the current values in the</span>
<a name="l00061"></a>00061 <span class="comment">                 * gyro1 ringbuffer</span>
<a name="l00062"></a>00062 <span class="comment">                 */</span>
<a name="l00063"></a>00063                 <span class="keywordtype">int</span> gyro1_average=0;
<a name="l00064"></a>00064                 
<a name="l00065"></a>00065                 <span class="comment">/* average value of the accelerometer, </span>
<a name="l00066"></a>00066 <span class="comment">                 * calculated out of the current values in the</span>
<a name="l00067"></a>00067 <span class="comment">                 * acclerometer ringbuffer</span>
<a name="l00068"></a>00068 <span class="comment">                 */</span>
<a name="l00069"></a>00069                 <span class="keywordtype">int</span> accel_high_average=0;
<a name="l00070"></a>00070                 <span class="keywordtype">int</span> accel_low_average=0;
<a name="l00071"></a>00071                 
<a name="l00072"></a>00072                 <span class="comment">/* PHI-value of kalman filter, estimate/predict the next position */</span>
<a name="l00073"></a>00073                 <span class="keywordtype">double</span> phi=0.0;
<a name="l00074"></a>00074                 
<a name="l00075"></a>00075                 <span class="comment">/* Delta t: Time interval between a loop execution */</span><span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">                /** TODO: This need to be a guaranteed, fixed value</span>
<a name="l00077"></a>00077 <span class="comment">                 * or be measured by timestamp difference on each run! */</span>
<a name="l00078"></a>00078                 <span class="keywordtype">double</span> delta_t = 0.01; <span class="comment">/* 1 millisecond */</span> 
<a name="l00079"></a>00079                 
<a name="l00080"></a>00080                 <span class="comment">/* set value (actuating variable) of controlling algorithm */</span>  
<a name="l00081"></a>00081                 <span class="keywordtype">double</span> balance=0.0;
<a name="l00082"></a>00082                 
<a name="l00083"></a>00083                 <span class="comment">/* value holding the current speed of the device */</span>  
<a name="l00084"></a>00084                 <span class="keywordtype">double</span> cur_speed=0.0;
<a name="l00085"></a>00085                 
<a name="l00086"></a>00086                 <span class="comment">/* analogue value of the steering potentiometer */</span>
<a name="l00087"></a>00087                 uint16_t steering_potential;
<a name="l00088"></a>00088                 
<a name="l00089"></a>00089                 <span class="comment">/* scaled value of the steering */</span>
<a name="l00090"></a>00090                 <span class="keywordtype">double</span> steering=0.0;
<a name="l00091"></a>00091                 
<a name="l00092"></a>00092                 <span class="comment">/* set value after the steering command was applied to it */</span>
<a name="l00093"></a>00093                 <span class="keywordtype">double</span> steer_cmd=0.0;
<a name="l00094"></a>00094                 
<a name="l00095"></a>00095                 <span class="comment">/* PWM duty value for motor 1 */</span>
<a name="l00096"></a>00096                 <span class="keywordtype">double</span> motor1_duty=0.0;
<a name="l00097"></a>00097                 uint8_t motor1_dir=0;
<a name="l00098"></a>00098                 <span class="comment">/* PWM duty value for motor 2 */</span>
<a name="l00099"></a>00099                 <span class="keywordtype">double</span> motor2_duty=0.0;
<a name="l00100"></a>00100                 uint8_t motor2_dir=0;
<a name="l00101"></a>00101                 
<a name="l00102"></a>00102                 <span class="comment">/* index variable, for summing up ringbuffer-values */</span>
<a name="l00103"></a>00103                 uint8_t rb_idx;
<a name="l00104"></a>00104                 
<a name="l00105"></a>00105 <span class="preprocessor">                #ifdef STABILIZE_DEBUG</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>                        <span class="keywordtype">char</span> buf[64]; <span class="comment">/* buffer for debug output */</span>
<a name="l00107"></a>00107 <span class="preprocessor">                #endif</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>                
<a name="l00109"></a>00109                 <span class="comment">/* *****************************  C O D E ******************/</span>
<a name="l00110"></a>00110                 <span class="comment">/* controller algorithm starts here */</span>
<a name="l00111"></a>00111                 
<a name="l00112"></a>00112                 <span class="comment">/* get the current value of the steering */</span>
<a name="l00113"></a>00113                 <a class="code" href="group__ro__adc.html#g2c7a22b5e74fbc930e5e4c6a0633b3f3">adc_sel_channel</a>( <a class="code" href="group__ro__adc.html#geb2b66d86543329c18ee38b5d676043f">ADC_STEERING_1</a> );
<a name="l00114"></a>00114                 steering_potential = <a class="code" href="group__ro__adc.html#g44aa940d70eb32e3293a0824943927f8">read_adc</a>();
<a name="l00115"></a>00115                 <span class="comment">/* scale value to be used in algorithm */</span>
<a name="l00116"></a>00116                 steering = ( (double)steering_potential-<a class="code" href="stabilizer_8h.html#a49e35e5eba9ca864421e9019238d346">STEERING_ZERO_POINT</a>) * <a class="code" href="stabilizer_8h.html#8366037faafd04166b46051a38ad1586">STEERING_RESPONSIVENESS</a>; 
<a name="l00117"></a>00117                 
<a name="l00118"></a>00118                 <span class="comment">/* </span>
<a name="l00119"></a>00119 <span class="comment">                 * 1st STEP: calculate the current average values of the sensors </span>
<a name="l00120"></a>00120 <span class="comment">                 * */</span>
<a name="l00121"></a>00121                 
<a name="l00122"></a>00122                 <span class="comment">/* Accelerometer average: */</span> 
<a name="l00123"></a>00123                 <span class="keywordflow">for</span>( rb_idx = 0; rb_idx &lt; <a class="code" href="group__ro__globals.html#g65722f3de281151a8ad20ab42556f894">ACCL_SAMPLES_BUFSIZE</a>; rb_idx++ )
<a name="l00124"></a>00124                 {
<a name="l00125"></a>00125                         accel_high_average +=   <a class="code" href="group__ro__globals.html#gb3a23c6a3619f9f782ad505bd5700bc2">accl_high_samples</a>[ rb_idx ];
<a name="l00126"></a>00126                         accel_low_average +=    <a class="code" href="group__ro__globals.html#g82b3b9358d663fddd337464079cb201c">accl_low_samples</a>[ rb_idx ];
<a name="l00127"></a>00127                 }
<a name="l00128"></a>00128                 <span class="comment">/* optimization: replace division by rightshift. currently works only for Bufsize 8!</span>
<a name="l00129"></a>00129 <span class="comment">                 * ist the same as: accel_average = accel_average / ACCL_SAMPLES_BUFSIZE; */</span>
<a name="l00130"></a>00130                 accel_high_average = (accel_high_average &gt;&gt; 3);
<a name="l00131"></a>00131                 accel_low_average = (accel_low_average &gt;&gt; 3);
<a name="l00132"></a>00132                 
<a name="l00133"></a>00133                 <span class="comment">/* Gyroscope1 average: */</span>
<a name="l00134"></a>00134                 <span class="keywordflow">for</span>( rb_idx = 0; rb_idx &lt; <a class="code" href="group__ro__globals.html#g66385c3be72a1a5ffeb3859aa30af060">GYRO1_SAMPLES_BUFSIZE</a>; rb_idx++ )
<a name="l00135"></a>00135                         gyro1_average += <a class="code" href="group__ro__globals.html#gdf431d8f8d0d2f01f1ab06accecf8424">gyro1_samples</a>[ rb_idx ];
<a name="l00136"></a>00136                 
<a name="l00137"></a>00137                 <span class="comment">/* optimization: replace division by rightshift. currently works only for Bufsize 8! </span>
<a name="l00138"></a>00138 <span class="comment">                 * gyro1_average = gyro1_average / GYRO1_SAMPLES_BUFSIZE; */</span>
<a name="l00139"></a>00139                 gyro1_average = (gyro1_average &gt;&gt; 3);
<a name="l00140"></a>00140                 
<a name="l00141"></a>00141 <span class="preprocessor">                #ifdef STABILIZE_DEBUG</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>                        snprintf(buf,64,<span class="stringliteral">"\n\r1# G_avg %d, A_h %d A_l %d\n\r"</span>, 
<a name="l00143"></a>00143                                         gyro1_average, accel_high_average, accel_low_average ); 
<a name="l00144"></a>00144                         <a class="code" href="group__pfleury__uart.html#ge52facc0a56086a365bb0018160d8d71">uart_puts</a>(buf);
<a name="l00145"></a>00145 <span class="preprocessor">                #endif</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>                
<a name="l00147"></a>00147                 <span class="comment">/*</span>
<a name="l00148"></a>00148 <span class="comment">                 *  2nd STEP: scale the sensor-values to correct physical values </span>
<a name="l00149"></a>00149 <span class="comment">                 * */</span>
<a name="l00150"></a>00150                 
<a name="l00151"></a>00151                 <span class="comment">/* calculate tilt degree from acclerometer value */</span>
<a name="l00152"></a>00152                 <span class="comment">/* TODO: sin(x) seems to be appromimates by 1.0 ? in case: add this as info/comment for clarity */</span>
<a name="l00153"></a>00153                 tilt_degrees =  ( ((double)accel_low_average/(<span class="keywordtype">double</span>)accel_high_average) - 0.5) * <a class="code" href="stabilizer_8h.html#64d51047e317d0d7da457f60bcd47028">ACCL_TO_DEGREE_FACTOR</a>;
<a name="l00154"></a>00154                 
<a name="l00155"></a>00155                 <span class="comment">/* calculate angular speed from gyroskop1 value */</span>
<a name="l00156"></a>00156                 angular_speed = ((double)gyro1_average - <a class="code" href="stabilizer_8h.html#23edd713eb04c1f7b66eec97a198adb0">GYRO1_ZERO_VALUE</a>) * <a class="code" href="stabilizer_8h.html#2963d2e1ade8f16b08002541372d0ed2">GYRO_TO_OMEGA_FACTOR</a>;
<a name="l00157"></a>00157 <span class="preprocessor">                #ifdef STABILIZE_DEBUG</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>                        snprintf(buf, 64, <span class="stringliteral">"2# t: %d, s %d\n\r"</span>, (<span class="keywordtype">int</span>)(tilt_degrees*1000), (<span class="keywordtype">int</span>)(angular_speed*1000));
<a name="l00159"></a>00159                         <a class="code" href="group__pfleury__uart.html#ge52facc0a56086a365bb0018160d8d71">uart_puts</a>(buf);
<a name="l00160"></a>00160 <span class="preprocessor">                #endif</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>                <span class="comment">/* </span>
<a name="l00162"></a>00162 <span class="comment">                 * 3rd STEP: process kalman step, predict new tilt angle </span>
<a name="l00163"></a>00163 <span class="comment">                 * */</span>
<a name="l00164"></a>00164                 <span class="comment">/* ANNOTATION: The correction factor "k_korrekt" was 1.0, so it was omitted.</span>
<a name="l00165"></a>00165 <span class="comment">                 * it is define as  K_CORR_FACTOR in stabilizer.h and can be added, if needed </span>
<a name="l00166"></a>00166 <span class="comment">                 * */</span>
<a name="l00167"></a>00167                 phi += (angular_speed - (phi - tilt_degrees)) * delta_t;
<a name="l00168"></a>00168                 <span class="comment">/* limit kalman output */</span>
<a name="l00169"></a>00169                 <span class="keywordflow">if</span>( phi &gt; (<a class="code" href="stabilizer_8h.html#598a3330b3c21701223ee0ca14316eca">PI</a>/4.0) )
<a name="l00170"></a>00170                         phi = (<a class="code" href="stabilizer_8h.html#598a3330b3c21701223ee0ca14316eca">PI</a>/4.0);
<a name="l00171"></a>00171                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>( phi &lt; ( (-1.0)*(<a class="code" href="stabilizer_8h.html#598a3330b3c21701223ee0ca14316eca">PI</a>/4.0) ) )
<a name="l00172"></a>00172                         phi = (-1)*(<a class="code" href="stabilizer_8h.html#598a3330b3c21701223ee0ca14316eca">PI</a>/4.0);
<a name="l00173"></a>00173                 
<a name="l00174"></a>00174 <span class="preprocessor">                #ifdef STABILIZE_DEBUG</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>                        snprintf(buf, 64, <span class="stringliteral">"3# phi: %d\n\r"</span>, 
<a name="l00176"></a>00176                                 (<span class="keywordtype">int</span>)(phi*1000) );
<a name="l00177"></a>00177                         <a class="code" href="group__pfleury__uart.html#ge52facc0a56086a365bb0018160d8d71">uart_puts</a>(buf);
<a name="l00178"></a>00178 <span class="preprocessor">                #endif</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>                <span class="comment">/*</span>
<a name="l00180"></a>00180 <span class="comment">                 * 4th STEP: calculate new setting value from predicted tilt angle and set point</span>
<a name="l00181"></a>00181 <span class="comment">                 */</span>
<a name="l00182"></a>00182                 <span class="comment">/* calculate new value as a weighted sum of tilt-angle and angular speed */</span>
<a name="l00183"></a>00183                 balance = (<a class="code" href="stabilizer_8h.html#aeb0d289a6c0bcd92cf00d9ba462d816">K_ANGLE</a>*( phi + <a class="code" href="stabilizer_8h.html#513c42d8dbcacf9f9f7dde6914a496f5">SET_POINT</a> )) + (<a class="code" href="stabilizer_8h.html#df0bd5f884ff5fc0e120a13d9de4afac">K_OMEGA</a> * angular_speed);
<a name="l00184"></a>00184                 
<a name="l00185"></a>00185                 <span class="comment">/* update current speed */</span>
<a name="l00186"></a>00186                 cur_speed += <a class="code" href="stabilizer_8h.html#a4a6a13b91688973362edab491ec5801">CUR_SPEED_FACTOR</a> * balance * delta_t;
<a name="l00187"></a>00187                 <span class="comment">/* add current speed to set value */</span>
<a name="l00188"></a>00188                 balance += cur_speed;
<a name="l00189"></a>00189                 
<a name="l00190"></a>00190                 <span class="keywordflow">if</span>(cur_speed &lt; 0.0 ) <span class="comment">/* cur_speed negative, driving backward */</span>
<a name="l00191"></a>00191                         cur_speed = -cur_speed;
<a name="l00192"></a>00192                         
<a name="l00193"></a>00193 <span class="preprocessor">                #ifdef STABILIZE_DEBUG</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>                        snprintf(buf, 64, <span class="stringliteral">"4# bal: %d, cur:%d\n\r"</span>, 
<a name="l00195"></a>00195                                 (<span class="keywordtype">int</span>)balance*1000,(<span class="keywordtype">int</span>)(cur_speed*1000) );
<a name="l00196"></a>00196                         <a class="code" href="group__pfleury__uart.html#ge52facc0a56086a365bb0018160d8d71">uart_puts</a>(buf);
<a name="l00197"></a>00197 <span class="preprocessor">                #endif</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>                <span class="comment">/*</span>
<a name="l00199"></a>00199 <span class="comment">                 * 5th STEP: apply steering, limit output, set motors</span>
<a name="l00200"></a>00200 <span class="comment">                 */</span>
<a name="l00201"></a>00201                 
<a name="l00202"></a>00202                 steer_cmd = (0.07*steering)/(0.3+cur_speed);
<a name="l00203"></a>00203                 
<a name="l00204"></a>00204                 <span class="comment">/* apply the steer command to the set value for each wheel */</span>
<a name="l00205"></a>00205                 motor1_duty = (balance + steer_cmd);
<a name="l00206"></a>00206                 motor2_duty = (balance - steer_cmd);
<a name="l00207"></a>00207                 
<a name="l00208"></a>00208                 <span class="comment">/* cut the set value to maximum duty cycle (100%, 1.0) */</span>
<a name="l00209"></a>00209                 <span class="keywordflow">if</span>( motor1_duty &gt; 1.0 ) <span class="comment">/* limit foward speed 1*/</span> 
<a name="l00210"></a>00210                         motor1_duty = 1.0;
<a name="l00211"></a>00211                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>( motor1_duty &lt; 0.0 )
<a name="l00212"></a>00212                 {  
<a name="l00213"></a>00213                         motor1_dir = 1; <span class="comment">/* drive M1 backward */</span>
<a name="l00214"></a>00214                         <span class="keywordflow">if</span>( motor1_duty &lt; -1.0 ) <span class="comment">/* limit backward speed 1 */</span> 
<a name="l00215"></a>00215                                 motor1_duty = -1.0;
<a name="l00216"></a>00216                         motor1_duty *= -1.0; <span class="comment">/* duty  must be positive */</span>
<a name="l00217"></a>00217                 }       
<a name="l00218"></a>00218                 <span class="keywordflow">if</span>( motor2_duty &gt; 1.0 ) <span class="comment">/* limit forward speed 2 */</span>
<a name="l00219"></a>00219                         motor2_duty = 1.0;
<a name="l00220"></a>00220                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>( motor2_duty &lt; 0.0 )
<a name="l00221"></a>00221                 {
<a name="l00222"></a>00222                         motor2_dir = 1; <span class="comment">/* drive M2 backward */</span> 
<a name="l00223"></a>00223                         <span class="keywordflow">if</span>( motor2_duty &lt; 1.0 )
<a name="l00224"></a>00224                                 motor2_duty = 1.0; <span class="comment">/* limit backwart speed 2 */</span>
<a name="l00225"></a>00225                         motor2_duty *= -1.0; <span class="comment">/* duty  must be positive */</span>
<a name="l00226"></a>00226                 }
<a name="l00227"></a>00227                 
<a name="l00228"></a>00228                 
<a name="l00229"></a>00229 <span class="preprocessor">                #ifdef STABILIZE_DEBUG</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>                        snprintf(buf, 64, <span class="stringliteral">"5# M1: %d,%d M2 %d,%d\n\r"</span>, 
<a name="l00231"></a>00231                                 (<span class="keywordtype">int</span>)(motor1_duty*<a class="code" href="group__ro__motor__pwm.html#gd53655e6cac4dfd2c67ecda5eea77a4e">PWM_RESOLUTION</a>), motor1_dir,(<span class="keywordtype">int</span>)(motor2_duty*PWM_RESOLUTION), motor2_dir);
<a name="l00232"></a>00232                         <a class="code" href="group__pfleury__uart.html#ge52facc0a56086a365bb0018160d8d71">uart_puts</a>(buf);
<a name="l00233"></a>00233 <span class="preprocessor">                #endif</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span>                
<a name="l00235"></a>00235                 <span class="comment">/* set the motors PWM signal */</span>
<a name="l00236"></a>00236                 <a class="code" href="group__ro__motor__pwm.html#g924cff55240daf42ea54e664f73f654e">set_motor1</a>( motor1_duty*PWM_RESOLUTION, motor1_dir );
<a name="l00237"></a>00237                 <a class="code" href="group__ro__motor__pwm.html#gc9b6d3d13b12f1b363f56ec624e5a7c3">set_motor2</a>( motor2_duty*PWM_RESOLUTION, motor2_dir );
<a name="l00238"></a>00238                 
<a name="l00239"></a>00239                 
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Dec 18 23:32:26 2006 for Controllerboard for balancing Scooter, Testsuite by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
